var autoComplete=function(e){function t(e,t){return e.classList?e.classList.contains(t):new RegExp("\\b"+t+"\\b").test(e.className)}function s(e,t,s){e.attachEvent?e.attachEvent("on"+t,s):e.addEventListener(t,s)}function o(e,t,s){e.detachEvent?e.detachEvent("on"+t,s):e.removeEventListener(t,s)}function n(e,o,n,a){s(a||document,o,(function(s){for(var o,a=s.target||s.srcElement;a&&!(o=t(a,e));)a=a.parentElement;o&&n.call(a,s)}))}var a,c,l,i,r,u,d;if(document.querySelector){for(l in(a=this).shortcutMode=!1,c={selector:0,source:0,minChars:3,delay:150,cache:1,menuClass:"",cacheMax:3e3,minSuggestionsBoxSize:250,shortcutChar:":",renderItem:function(e,t){t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");var s=new RegExp("("+t.split(" ").join("|")+")","gi");return'<div class="autocomplete-suggestion" data-val="'+e+'">'+e.replace(s,"<b>$1</b>")+"</div>"},filterItems:function(e){return e},onSelect:function(){}},e)e.hasOwnProperty(l)&&(c[l]=e[l]);var m="",h="",g="object"==typeof c.selector?[c.selector]:document.querySelectorAll(c.selector);for(i=0;i<g.length;i++)(r=g[i]).sc=document.createElement("div"),r.sc.className="autocomplete-suggestions "+c.menuClass,r.autocompleteAttr=r.getAttribute("autocomplete"),r.setAttribute("autocomplete","off"),r.cache=[],r.searches=[],r.last_val="",enterUseSuggestion=!1,r.updateSC=function(e,t){var s,o,n=r.getBoundingClientRect();r.sc.style.left=n.left+(window.pageXOffset||document.documentElement.scrollLeft)+"px",r.sc.style.top=n.bottom+(window.pageYOffset||document.documentElement.scrollTop)+1+"px",r.sc.style.width=n.right-n.left>=c.minSuggestionsBoxSize?n.right-n.left+"px":c.minSuggestionsBoxSize+"px",!e&&r.sc.querySelector(".autocomplete-suggestion")&&(r.sc.style.display="block",r.sc.maxHeight||(r.sc.maxHeight=parseInt((window.getComputedStyle?getComputedStyle(r.sc,null):r.sc.currentStyle).maxHeight)),r.sc.suggestionHeight||(r.sc.suggestionHeight=r.sc.querySelector(".autocomplete-suggestion").offsetHeight),r.sc.suggestionHeight&&(t?(s=r.sc.scrollTop,(o=t.getBoundingClientRect().top-r.sc.getBoundingClientRect().top)+r.sc.suggestionHeight-r.sc.maxHeight>0?r.sc.scrollTop=o+r.sc.suggestionHeight+s-r.sc.maxHeight:o<0&&(r.sc.scrollTop=o+s)):r.sc.scrollTop=0))},s(window,"resize",r.updateSC),document.body.appendChild(r.sc),n("autocomplete-suggestion","mouseleave",(function(){var e=r.sc.querySelector(".autocomplete-suggestion.hover");e&&setTimeout((function(){e.className=e.className.replace("hover","")}),20),enterUseSuggestion=!1}),r.sc),n("autocomplete-suggestion","mouseover",(function(){var e=r.sc.querySelector(".autocomplete-suggestion.hover");e&&(e.className=e.className.replace("hover","")),this.className+=" hover",(e=r.sc.querySelector(".autocomplete-footer.hover"))&&(e.className=e.className.replace(" hover","")),enterUseSuggestion=!1}),r.sc),n("autocomplete-suggestion","mousedown",(function(e){if(t(this,"autocomplete-suggestion")){var s=this.getAttribute("data-val"),o=this.getAttribute("data-dict");JSON.parse(decodeURIComponent(s)),c.onSelect(e,s,this),r.value="",r.last_val="",document.getElementById(c.selector.substr(1)).classList.remove("dict"),o&&setTimeout((function(){document.getElementById("fSelect").classList.add("shake"),setTimeout((function(){document.getElementById("fSelect").classList.remove("shake")}),200)}),20),setTimeout((function(){r.sc.style.display="none",document.getElementById(c.selector.substr(1)).focus()}),250)}}),r.sc),n("actips","mousedown",(function(e){if(t(this,"actips")){var s=this.getAttribute("data-val");c.onSelect(e,s,this),setTimeout((function(){r.sc.style.display="none"}),250)}}),r.sc),n("autocomplete-footer","mousedown",(function(e){if(t(this,"autocomplete-footer")){var s=this.getAttribute("data-val");c.onSelect(e,s,this),setTimeout((function(){r.sc.style.display="none"}),250)}}),r.sc),n("autocomplete-footer","mouseover",(function(){var e=r.sc.querySelector(".autocomplete-suggestion.hover");e&&(e.className=e.className.replace(" hover","")),this.className+=" hover",enterUseSuggestion=!1}),r.sc),r.blurHandler=function(){var e=document.querySelector(".autocomplete-suggestions.hover"),t=document.querySelector(".autocomplete-footer.hover"),s=document.getElementById("kbd_mka");e||t||s&&"none"!==s.style?r!==document.activeElement&&setTimeout((function(){"fSelect"!=document.activeElement.id&&r.focus()}),20):(r.value.slice(0,1)==c.shortcutChar?r.value=r.last_val:r.last_val=r.value,r.sc.style.display="none",setTimeout((function(){r.sc.style.display="none"}),350))},s(r,"blur",r.blurHandler),u=function(e){var t,s=r.cache,o=[];if(e.length>0){for(t=0;t<s.length;t++)void 0===s[t].ls&&o.push(s[t]);r.cache=o}else if(0==e.length){for(t=0;t<s.length;t++)1==typeof s[t].ls&&o.push(s[t]);r.cache=o,r.searches=[]}},d=function(e){var t,s,o,n,l=r.value;for(r.cache.length>=r.cacheMax&&(r.cache=[]),t=e.length,s=0;s<t;s++)(a.shortcutMode?r.cache.some((function(t){return t.name==e[s].name&&t.dict==e[s].dict})):r.cache.some((function(t){return t.term==e[s].term&&t.language==e[s].language&&t.pinyn==e[s].pinyn&&t.transcription==e[s].transcription})))||r.cache.push(e[s]);if(e.length&&l.length>=c.minChars){for(e=c.filterItems(e,l),o=m,n=0;n<e.length;n++)o+=c.renderItem(e[n],l);o+=h,r.sc.innerHTML=o,r.updateSC(0)}else r.sc.style.display="none"},r.keydownHandler=function(e){var s,o,n,l,i,u=window.event?e.keyCode:e.which;if(38==u&&e.preventDefault(),(40==u||38==u)&&r.sc.innerHTML&&("none"!=r.sc.style.display||r.value.length>0))return l=r.sc.querySelector(".autocomplete-suggestion.hover"),i=r.sc.querySelector(".autocomplete-footer.hover"),l?(s=40==u?l.nextSibling:l.previousSibling)?(l.className=l.className.replace("hover",""),s.className+=" hover",o=t(s,"autocomplete-footer"),n=t(s,"autocomplete-header"),o||n||!s.hasAttribute("data-val")||s.hasAttribute("data-dict")?!o&&!n&&s.hasAttribute("data-val")&&s.hasAttribute("data-dict")?r.value=c.shortcutChar+JSON.parse(decodeURIComponent(s.getAttribute("data-val"))).name:(r.value=r.last_val,s=0):r.value=JSON.parse(decodeURIComponent(s.getAttribute("data-val"))).term):(l.className=l.className.replace("hover",""),r.value=r.last_val,s=0):(i?(s=40==u?r.sc.querySelector(".autocomplete-suggestion"):i.previousSibling,i.className=i.className.replace("hover","")):s=40==u?r.sc.querySelector(".autocomplete-suggestion"):r.sc.childNodes[r.sc.childNodes.length-1],s.className+=" hover",o=t(s,"autocomplete-footer"),n=t(s,"autocomplete-header"),o||n||!s.hasAttribute("data-val")||s.hasAttribute("data-dict")?!o&&!n&&s.hasAttribute("data-val")&&s.hasAttribute("data-dict")?r.value=c.shortcutChar+JSON.parse(decodeURIComponent(s.getAttribute("data-val"))).name:(r.value=r.last_val,s=0):r.value=JSON.parse(decodeURIComponent(s.getAttribute("data-val"))).term),enterUseSuggestion=!0,r.updateSC(0,s),!1;if(27==u)r.value=r.last_val,r.sc.style.display="none",enterUseSuggestion=!1;else if(13!=u&&9!=u||!0!==enterUseSuggestion){if((13==u||9==u||32==u)&&a.shortcutMode&&(e.preventDefault(),!r.sc.querySelector(".autocomplete-suggestion.hover"))){let t=r.value.slice(1,r.value.length).trim(),s=r.cache.find((function(e){return e.dict&&e.dict==t||e.name&&deaccent(e.name.toLowerCase())==deaccent(t.toLowerCase())}));if(s)c.onSelect(e,JSON.stringify(s),this),setTimeout((function(){r.sc.style.display="none",enterUseSuggestion=!1,document.getElementById("fSelect").classList.add("shake"),setTimeout((function(){document.getElementById("fSelect").classList.remove("shake")}),200)}),20);else if(9==u&&r.sc.querySelector(".autocomplete-suggestion[data-dict]")){let e=r.sc.querySelector(".autocomplete-suggestion[data-dict]");if(e){var d=e.getAttribute("data-val"),m=(this.getAttribute("data-dict"),JSON.parse(decodeURIComponent(d)));e.classList.add("hover"),r.value=c.shortcutChar+m.name}}}}else l=r.sc.querySelector(".autocomplete-suggestion.hover"),(i=r.sc.querySelector(".autocomplete-footer.hover"))&&(l=i),l&&"none"!=r.sc.style.display&&(e.preventDefault(),l.hasAttribute("data-dict")&&(r.last_val=""),c.onSelect(e,l.getAttribute("data-val"),l),setTimeout((function(){r.sc.style.display="none",enterUseSuggestion=!1,document.getElementById("fSelect").classList.add("shake"),setTimeout((function(){document.getElementById("fSelect").classList.remove("shake")}),200)}),20))},s(r,"keydown",r.keydownHandler),r.keyupHandler=function(e){var t,s,o,n,l,i;if(a.shortcutMode=r.value.length>0&&r.value.slice(0,1)==c.shortcutChar,u(r.value),t=window.event?e.keyCode:e.which,a.shortcutMode?(document.getElementById(c.selector.substr(1)).classList.add("dict"),r.last_val.length>0&&r.last_val.slice(0,1)!=c.shortcutChar&&(r.last_val="",r.searches=[])):document.getElementById(c.selector.substr(1)).classList.remove("dict"),!t||(t<35||t>40)&&13!=t&&27!=t)if(s=deaccent(r.value),val=a.shortcutMode?s.slice(1,s.length):s,s.length>=c.minChars){if(s!=r.last_val){if(o=r.last_val,r.last_val=s,clearTimeout(r.timer),1==c.cache&&1==r.searches.some((function(e){return s.indexOf(e)>-1}))&&(o.length<val.length||r.cache.some((function(e){return e.term&&e.term.indexOf(val)>-1||e.pinyn&&e.pinyn.indexOf(val)>-1||e.dict&&e.dict.indexOf(val)>-1||e.name&&e.name.indexOf(val)>-1})))&&(n=[],32==t||189==t||109==t?(l=val.substr(0,val.length-1),n=r.cache.filter((function(e){return e.term&&0==deaccent(e.term).indexOf(l+" ")||e.term&&0==deaccent(e.term).indexOf(l+"-")||e.pinyn&&(0==deaccent(e.pinyn).indexOf(l+" ")||0==deaccent(e.pinyn).indexOf(l+"-"))||e.dict&&0==deaccent(e.dict).indexOf(l+"-")||e.name&&0==deaccent(e.name).indexOf(l+"-")}))):(i=new RegExp("^"+val,"i"),n=r.cache.filter((function(e){return e.term&&i.test(deaccent(e.term))||e.pinyn&&i.test(deaccent(e.pinyn))||e.transcription&&i.test(deaccent(e.transcription))||e.dict&&i.test(deaccent(e.dict))||e.name&&i.test(deaccent(e.name))}))),n.length>0))return void d(n);r.timer=setTimeout((function(){!r.searches.some((function(e){return e===s}))&&s.length>0&&r.searches.push(s),c.source(s,d)}),c.delay)}}else r.last_val=s,r.sc.style.display="none"},s(r,"keyup",r.keyupHandler),r.clickHandler=function(e){r.last_val="\n",r.keyupHandler(e)},c.minChars||s(r,"click",r.clickHandler);this.setHeader=function(e){m=e},this.setFooter=function(e){h=e},this.destroy=function(){for(var e,t=0;t<g.length;t++)e=g[t],o(window,"resize",e.updateSC),o(e,"blur",e.blurHandler),o(e,"click",e.clickHandler),o(e,"keydown",e.keydownHandler),o(e,"keyup",e.keyupHandler),e.autocompleteAttr?e.setAttribute("autocomplete",e.autocompleteAttr):e.removeAttribute("autocomplete"),document.body.removeChild(e.sc),e=null}}};"function"==typeof define&&define.amd?define("autoComplete",(function(){return autoComplete})):window.autoComplete=autoComplete;